<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Masomo Landlord Payment System</title>
  <style>
    body { font-family: Arial; margin: 20px; background:#f6f7fb; }
    h2 { color:#2a7f62; }
    input, select, button { margin:6px 0; padding:8px 12px; border-radius:4px; border:1px solid #ccc; }
    button { background:#2a7f62; color:#fff; border:none; cursor:pointer; }
    button:hover { opacity:0.9; }
    .logout-btn { background:#c0392b; margin-top:10px; }
    .small { font-size:12px; color:#555; }
    table { border-collapse: collapse; width:100%; margin-top:12px; min-width:600px; }
    th, td { border:1px solid #e6eef7; padding:6px; text-align:left; }
    th { background:#f3f7fb; }
    .msg { margin:12px 0; color:#2a7f62; font-weight:600; text-align:center; }
    .scroll-container { overflow-x:auto; }
    /* Center login box */
    #loginDiv {
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    #loginDiv input, #loginDiv button { width:250px; }
  </style>
</head>
<body>
  <div id="loginDiv">
    <!-- Add Font Awesome for icons (if not already included above) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Rent Collection Features Section -->
<div style="margin: 20px auto; max-width: 600px; padding: 20px; background: #ffffffcc; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
  <h3 style="color:#2a7f62; font-size: 20px; margin-bottom: 15px; text-align:center;">Rent Collection Dashboard</h3>
  <ul style="list-style: none; padding-left: 0; color:#333; font-size: 16px; line-height: 1.8;">
    <li><i class="fas fa-filter" style="color:#2a7f62; margin-right:8px;"></i> Filter and view <strong>plots/buildings</strong> you own</li>
    <li><i class="fas fa-hand-holding-usd" style="color:#2a7f62; margin-right:8px;"></i> Receive <strong>rent payments</strong> securely</li>
    <li><i class="fas fa-paper-plane" style="color:#2a7f62; margin-right:8px;"></i> Instantly send <strong>SMS confirmation</strong> to tenants</li>
    <li><i class="fas fa-receipt" style="color:#2a7f62; margin-right:8px;"></i> Automatically update tenant <strong>status to Paid</strong></li>
    <li><i class="fas fa-chart-line" style="color:#2a7f62; margin-right:8px;"></i> Get a <strong>clear overview</strong> of all payments</li>
  </ul>
</div>

    <h2>Login to Receive Rent</h2>
    <input type="text" id="nationalId" placeholder="National ID OR User ID">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <div id="loginMsg" style="color:red; margin-top:8px;"></div>
    <!-- Added wait message for login -->
    <div id="loginWait" style="display:none; color:green; font-weight:bold; margin-top:8px;">Wait please...</div>
  </div>

  <div id="dashboardDiv" style="display:none;">
    <h2>Welcome, <span id="landlordName"></span></h2>
    <div>Your Credits: <span id="landlordCredits" style="color:red; font-weight:bold;"></span></div>
    <div>Select Plot:
      <select id="plotSelect" onchange="loadTenants()">
        <option value="">--select plot--</option>
      </select>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>

    <div class="scroll-container">
      <div id="tenantsContainer"></div>
    </div>
  </div>

  <!-- Global Processing Message -->
  <div id="waitMsg" class="msg" style="display:none;">Please wait...</div>

<script>
const WORKER_URL = "https://weathered-fog-adf1.ev-dmaundu.workers.dev/";
let currentNationalId = "";

function showWait(msg="Please wait..."){ 
  document.getElementById("waitMsg").innerText = msg;
  document.getElementById("waitMsg").style.display="block"; 
}
function hideWait(){ document.getElementById("waitMsg").style.display="none"; }

async function apiCall(action, payload, waitMessage="Please wait...") {
  try {
    showWait(waitMessage);
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, payload })
    });
    hideWait();
    return await res.json();
  } catch (err) {
    hideWait();
    return { success: false, message: err.message };
  }
}

async function login() {
  const nid = document.getElementById("nationalId").value.trim();
  const pwd = document.getElementById("password").value;
  document.getElementById("loginMsg").innerText = "";
  document.getElementById("loginWait").style.display = "none";
  if(!nid||!pwd){ document.getElementById("loginMsg").innerText="Enter ID & Password"; return; }
  
  // Show "Wait please..." in bold green during login
  document.getElementById("loginWait").style.display = "block";

  const res = await apiCall("login", { nationalId: nid, password: pwd }, "Logging in...");
  document.getElementById("loginWait").style.display = "none";
  
  if(res.success){
    currentNationalId = res.nationalId;
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("dashboardDiv").style.display="block";
    document.getElementById("landlordName").innerText = res.name;
    document.getElementById("landlordCredits").innerText = res.credits;
    loadPlots();
  } else {
    document.getElementById("loginMsg").innerText = res.message;
  }
}

async function loadPlots() {
  const plots = await apiCall("getPlots", { nationalId: currentNationalId }, "Loading plots...");
  const sel=document.getElementById("plotSelect");
  sel.innerHTML="<option value=''>--select plot--</option>";
  plots.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.plotId;
    opt.textContent=p.plotName+" ("+p.location+")";
    sel.appendChild(opt);
  });
}

async function loadTenants() {
  const plotId=document.getElementById("plotSelect").value;
  const container=document.getElementById("tenantsContainer");
  container.innerHTML="";
  if(!plotId) return;
  const tenants = await apiCall("getTenants", { plotId }, "Loading tenants...");
  if(!tenants || tenants.length===0){ container.innerHTML="<div>No tenants found.</div>"; return; }
  let html="<table><thead><tr><th>Tenant</th><th>Phone</th><th>Rent</th><th>Payment Status</th><th>Month-Year</th><th>Action</th></tr></thead><tbody>";
  tenants.forEach(t=>{
    html+="<tr>";
    html+="<td>"+t.name+"</td>";
    html+="<td>0"+t.phone+"</td>";
    html+="<td>"+t.rent+"</td>";
    let statusColor = "black";
    if(t.paymentStatus === "Paid") statusColor = "green";
    else if(t.paymentStatus === "Pending") statusColor = "red";
    html += `<td style="color:${statusColor}; font-weight:bold;">${t.paymentStatus}</td>`;
    const disabledSelect = t.paymentStatus === "Paid" ? "disabled" : "";
    html += `<td><select id='monthYear-${t.tenantId}' ${disabledSelect}>${generateMonthYearOptions()}</select></td>`;
    const disabledBtn = t.paymentStatus === "Paid" ? "disabled" : "";
    html += `<td><button onclick='receivePayment("${t.tenantId}")' ${disabledBtn}>Receive Payment</button></td>`;
    html+="</tr>";
  });
  html+="</tbody></table>";
  container.innerHTML=html;
}

function generateMonthYearOptions(){
  const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const today=new Date();
  let options="";
  for(let y=today.getFullYear(); y>=today.getFullYear()-1; y--){
    for(let m=0;m<12;m++){
      options+="<option>"+months[m]+"-"+y+"</option>";
    }
  }
  return options;
}

async function receivePayment(tenantId){
  const sel=document.getElementById("monthYear-"+tenantId);
  if(!sel) return alert("Select Month-Year");
  const monthYear=sel.value;
  const res = await apiCall("receivePayment", { tenantId, monthYear, landlordNationalId: currentNationalId }, "Processing payment...");
  alert(res.message);
  loadTenants();
}

function logout(){
  currentNationalId="";
  document.getElementById("dashboardDiv").style.display="none";
  document.getElementById("loginDiv").style.display="flex";
  document.getElementById("nationalId").value="";
  document.getElementById("password").value="";
}
</script>
</body>
</html>
